<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      Content Security Policy (CSP) â€“ ×”×’× ×” × ×•×¡×¤×ª ××¤× ×™ ×”×ª×§×¤×•×ª ×¦×“ ×œ×§×•×— - React
      Project Guidelines
    </title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <main class="container">
      <header>
        <h1>Content Security Policy (CSP) â€“ ×”×’× ×” × ×•×¡×¤×ª ××¤× ×™ ×”×ª×§×¤×•×ª ×¦×“ ×œ×§×•×—</h1>
      </header>
      <nav>
        <a href="../index.html">â† ×—×–×¨×” ×œ×“×£ ×”×‘×™×ª</a>
      </nav>

      <section class="category">
        <h2>×œ××” CSP ×—×©×•×‘?</h2>
        <p>
          ×‘×¤×™×ª×•×— ××¤×œ×™×§×¦×™×•×ª React, ××¤×™×œ×• ×¢× ×›×œ ×”×”×’× ×•×ª ×©×œ ×‘×“×™×§×•×ª ×§×œ×˜
          ×•â€‘sanitization, ×¢×“×™×™×Ÿ ×§×™×™××ª ×¡×›× ×” ×œ×”×¨×¦×ª ×§×•×“ ×–×“×•× ×™ ×‘×“×¤×“×¤×Ÿ ×”××©×ª××©.
          Content Security Policy (CSP) ×”×™× ×©×›×‘×ª ×”×’× ×” × ×•×¡×¤×ª ×©××’×‘×™×œ×” ××™×œ×• ××©××‘×™×
          ×•×§×•×“ ×™×›×•×œ×™× ×œ×¨×•×¥ ×‘×“×¤×“×¤×Ÿ.
        </p>
        <ul>
          <li>××•× ×¢ ×”×ª×§×¤×•×ª XSS ×•×”×–×¨×§×•×ª ×¡×§×¨×™×¤×˜×™×.</li>
          <li>××’×‘×™×œ ×˜×¢×™× ×ª ×¡×§×¨×™×¤×˜×™×, CSS, ×ª××•× ×•×ª ×•××©××‘×™× ×¨×§ ×××§×•×¨×•×ª ××”×™×× ×™×.</li>
          <li>
            ××¤×—×™×ª ××ª ×”×¡×™×›×•×Ÿ ×œ×”×¨×¦×ª ×§×•×“ ×¦×“ ×©×œ×™×©×™ ×œ× ××‘×•×§×¨ ××• ×××§×•×¨×•×ª ×—×©×•×“×™×.
          </li>
          <li>×ª×•××š ×‘××‘×˜×—×” ×§×¤×“× ×™×ª ×’× ×× ×§×™×™××ª ×¤×’×™×¢×•×ª ×‘×§×•×“ ×”××¤×œ×™×§×¦×™×”.</li>
        </ul>
      </section>

      <section class="category">
        <h2>××™×š ×–×” ×¢×•×‘×“</h2>
        <h3>1. ×”×’×“×¨×ª ××“×™× ×™×•×ª CSP ×‘×©×¨×ª</h3>
        <p>
          CSP ××•×’×“×¨ ×‘×××¦×¢×•×ª HTTP headers (Content-Security-Policy) ××• meta tag
          ×‘â€‘HTML.
        </p>
        <p>×“×•×’××” ×‘×¡×™×¡×™×ª ×‘â€‘Express.js:</p>
        <pre dir="ltr"><code>import helmet from 'helmet';
import express from 'express';

const app = express();

// Basic CSP configuration
app.use(
  helmet.contentSecurityPolicy({
    directives: {
      defaultSrc: ["'self'"], // ×¨×§ ××”×“×•××™×™×Ÿ ×©×œ× ×•
      scriptSrc: [
        "'self'", 
        "https://trusted.cdn.com",
        "https://cdnjs.cloudflare.com",
        "'unsafe-inline'" // ×¨×§ ×‘××§×¨×™ ×—×™×¨×•× - ×œ× ××•××œ×¥
      ],
      styleSrc: [
        "'self'", 
        "https://fonts.googleapis.com",
        "'unsafe-inline'" // ×¢×‘×•×¨ styled-components ×‘××¦×‘ ×¤×™×ª×•×—
      ],
      imgSrc: [
        "'self'", 
        "data:", 
        "https:",
        "blob:"
      ],
      fontSrc: [
        "'self'",
        "https://fonts.gstatic.com"
      ],
      connectSrc: [
        "'self'",
        "https://api.myapp.com",
        "wss://websocket.myapp.com"
      ],
      mediaSrc: ["'self'"],
      objectSrc: ["'none'"], // ××•× ×¢ flash ×•-plugins
      frameSrc: ["'none'"], // ××•× ×¢ iframes
      baseUri: ["'self'"],
      formAction: ["'self'"],
      upgradeInsecureRequests: [],
    },
    reportOnly: false, // ×©× ×” ×œ-true ×œ×‘×“×™×§×” ×¨××©×•× ×™×ª
  })
);

// Advanced CSP with nonce support
app.use((req, res, next) => {
  // Generate a unique nonce for this request
  res.locals.nonce = require('crypto').randomBytes(16).toString('base64');
  next();
});

app.use(
  helmet.contentSecurityPolicy({
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: [
        "'self'",
        (req, res) => `'nonce-${res.locals.nonce}'`
      ],
      styleSrc: [
        "'self'",
        (req, res) => `'nonce-${res.locals.nonce}'`
      ],
    },
  })
);</code></pre>

        <h3>2. ×”×’×“×¨×” ×‘××¡×’×¨×ª React</h3>
        <p>Create React App:</p>
        <pre dir="ltr"><code>// public/index.html
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;meta
      http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' 'unsafe-eval';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://api.example.com;
      "
    /&gt;
    &lt;title&gt;React App&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id="root"&gt;&lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>

        <p>Next.js:</p>
        <pre dir="ltr"><code>// next.config.js
const ContentSecurityPolicy = `
  default-src 'self';
  script-src 'self' 'unsafe-eval' 'unsafe-inline';
  child-src *.youtube.com *.google.com;
  style-src 'self' 'unsafe-inline' *.googleapis.com;
  img-src * blob: data:;
  media-src 'none';
  connect-src *;
  font-src 'self' *.gstatic.com;
`;

const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: ContentSecurityPolicy.replace(/\n/g, ''),
  },
];

module.exports = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: securityHeaders,
      },
    ];
  },
};</code></pre>

        <h3>3. ×©×™××•×© ×‘××§×•×¨×•×ª ××”×™×× ×™× ×‘×œ×‘×“</h3>
        <p>×˜×¢×™× ×ª ×¡×¤×¨×™×•×ª ×¦×“ ×©×œ×™×©×™ (CDN) ×—×™×™×‘×ª ×œ×”×™×•×ª ××‘×•×§×¨×ª.</p>
        <pre dir="ltr"><code>// âŒ ×¨×¢ - inline script
&lt;script&gt;
  console.log('This will be blocked by CSP');
&lt;/script&gt;

// âœ… ×˜×•×‘ - external script ×××§×•×¨ ××”×™××Ÿ
&lt;script src="https://trusted.cdn.com/library.js"&gt;&lt;/script&gt;

// âœ… ×˜×•×‘ - script ×¢× nonce
&lt;script nonce="{{nonce}}"&gt;
  console.log('This is allowed with nonce');
&lt;/script&gt;</code></pre>

        <h3>4. ×“×™×•×•×— ×¢×œ ×”×¤×¨×•×ª (CSP Reporting)</h3>
        <p>××¤×©×¨ ×œ×”×’×“×™×¨ endpoint ×©×™×§×‘×œ ×“×•×—×•×ª ×›××©×¨ CSP × ×—×¦×”:</p>
        <pre dir="ltr"><code>// Server-side CSP violation reporting
app.use(
  helmet.contentSecurityPolicy({
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"],
      reportUri: '/csp-violation-report-endpoint',
    },
  })
);

// CSP violation report endpoint
app.post('/csp-violation-report-endpoint', express.json({ type: 'application/csp-report' }), (req, res) => {
  console.log('CSP Violation Report:', JSON.stringify(req.body, null, 2));
  
  // Log to monitoring system (Sentry, LogRocket, etc.)
  if (req.body && req.body['csp-report']) {
    const report = req.body['csp-report'];
    console.log({
      blockedUri: report['blocked-uri'],
      documentUri: report['document-uri'],
      violatedDirective: report['violated-directive'],
      originalPolicy: report['original-policy'],
      sourceFile: report['source-file'],
      lineNumber: report['line-number'],
      columnNumber: report['column-number'],
    });
  }
  
  res.status(204).send();
});

// Modern CSP Reporting API
app.use(
  helmet.contentSecurityPolicy({
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"],
      reportTo: 'csp-endpoint',
    },
  })
);

app.use((req, res, next) => {
  res.setHeader('Report-To', JSON.stringify({
    group: 'csp-endpoint',
    max_age: 10886400,
    endpoints: [{ url: '/csp-violation-report-endpoint' }],
  }));
  next();
});</code></pre>
      </section>

      <section class="category">
        <h2>CSP ×¢×‘×•×¨ React Development</h2>
        <pre dir="ltr"><code>// Development CSP (more permissive)
const developmentCSP = {
  defaultSrc: ["'self'"],
  scriptSrc: [
    "'self'",
    "'unsafe-eval'", // × ×“×¨×© ×¢×‘×•×¨ hot reloading
    "'unsafe-inline'", // × ×“×¨×© ×¢×‘×•×¨ inline scripts ×‘×¤×™×ª×•×—
    "localhost:*",
    "127.0.0.1:*",
  ],
  styleSrc: [
    "'self'",
    "'unsafe-inline'", // × ×“×¨×© ×¢×‘×•×¨ styled-components ×•-CSS-in-JS
    "localhost:*",
  ],
  imgSrc: ["'self'", "data:", "blob:", "localhost:*"],
  connectSrc: [
    "'self'",
    "ws://localhost:*", // ×¢×‘×•×¨ hot reloading WebSocket
    "wss://localhost:*",
    "localhost:*",
  ],
};

// Production CSP (restrictive)
const productionCSP = {
  defaultSrc: ["'self'"],
  scriptSrc: [
    "'self'",
    "https://trusted-cdn.com",
    // ×× ××©×ª××©×™× ×‘-nonce
    (req, res) => `'nonce-${res.locals.nonce}'`,
  ],
  styleSrc: [
    "'self'",
    "https://fonts.googleapis.com",
    // ×¢×‘×•×¨ styled-components ×‘×¤×¨×•×“×§×©×Ÿ
    "'sha256-47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU='",
  ],
  imgSrc: ["'self'", "https:", "data:"],
  fontSrc: ["'self'", "https://fonts.gstatic.com"],
  connectSrc: ["'self'", "https://api.myapp.com"],
  objectSrc: ["'none'"],
  mediaSrc: ["'self'"],
  frameSrc: ["'none'"],
  baseUri: ["'self'"],
  formAction: ["'self'"],
  upgradeInsecureRequests: [],
};

// Environment-based CSP
const cspConfig = process.env.NODE_ENV === 'production' 
  ? productionCSP 
  : developmentCSP;

app.use(helmet.contentSecurityPolicy({ directives: cspConfig }));</code></pre>
      </section>

      <section class="category">
        <h2>React Component ×¢× CSP Nonce</h2>
        <pre dir="ltr"><code>// Hook ×œ× ×™×”×•×œ nonce
import { useContext, createContext } from 'react';

const NonceContext = createContext('');

export const NonceProvider = ({ nonce, children }) => (
  &lt;NonceContext.Provider value={nonce}&gt;
    {children}
  &lt;/NonceContext.Provider&gt;
);

export const useNonce = () => useContext(NonceContext);

// ×©×™××•×© ×‘-component
function DynamicScript({ code }) {
  const nonce = useNonce();
  
  return (
    &lt;script 
      nonce={nonce}
      dangerouslySetInnerHTML={{ __html: code }}
    /&gt;
  );
}

// Server-side rendering ×¢× nonce
function App() {
  const nonce = res.locals.nonce; // ××”×©×¨×ª
  
  return (
    &lt;NonceProvider nonce={nonce}&gt;
      &lt;div&gt;
        &lt;DynamicScript code="console.log('Safe script');" /&gt;
      &lt;/div&gt;
    &lt;/NonceProvider&gt;
  );
}</code></pre>
      </section>

      <section class="category">
        <h2>CSP Testing ×•-Debugging</h2>
        <pre dir="ltr"><code>// CSP Validator utility
class CSPValidator {
  static validateInlineScript(content, csp) {
    const hasUnsafeInline = csp.scriptSrc.includes("'unsafe-inline'");
    const hasNonce = csp.scriptSrc.some(src => src.startsWith("'nonce-"));
    const hasHash = csp.scriptSrc.some(src => src.startsWith("'sha"));
    
    if (!hasUnsafeInline && !hasNonce && !hasHash) {
      console.warn('Inline script blocked by CSP:', content);
      return false;
    }
    
    return true;
  }
  
  static checkExternalResource(url, directive) {
    const allowedSources = directive || ["'self'"];
    const isAllowed = allowedSources.some(source => {
      if (source === "'self'") return url.startsWith(window.location.origin);
      if (source === "https:") return url.startsWith('https:');
      if (source === "*") return true;
      return url.startsWith(source);
    });
    
    if (!isAllowed) {
      console.warn(`Resource blocked by CSP: ${url}`);
    }
    
    return isAllowed;
  }
}

// Development helper
if (process.env.NODE_ENV === 'development') {
  // Monitor CSP violations in console
  document.addEventListener('securitypolicyviolation', (e) => {
    console.group('ğŸ›¡ï¸ CSP Violation');
    console.log('Blocked URI:', e.blockedURI);
    console.log('Violated Directive:', e.violatedDirective);
    console.log('Original Policy:', e.originalPolicy);
    console.log('Source File:', e.sourceFile);
    console.log('Line Number:', e.lineNumber);
    console.groupEnd();
  });
}</code></pre>
      </section>

      <section class="category">
        <h2>×˜×™×¤×™× ×œ××™××•×© ×™×¢×™×œ</h2>
        <ul>
          <li>
            ×œ×”×ª×—×™×œ ×¢× CSP ×¨×›×” (report-only) ×›×“×™ ×œ×‘×“×•×§ ××ª ×”×”×©×¤×¢×” ×¢×œ ×”××¤×œ×™×§×¦×™×”
            ×œ×¤× ×™ ×”×¤×¢×œ×” ××œ××”.
          </li>
          <li>×œ×”×™×× ×¢ ××©×™××•×© ×‘â€‘unsafe-inline ××• unsafe-eval ×›×›×œ ×”××¤×©×¨.</li>
          <li>
            ×œ×©×œ×‘ CSP ×¢× ×©×™×˜×•×ª ××—×¨×•×ª ×›××• input validation ×•â€‘sanitization ×œ×§×‘×œ×ª
            ×”×’× ×” ××§×¦×” ×œ×§×¦×”.
          </li>
          <li>
            ×œ×¢×“×›×Ÿ ××ª ×”××“×™× ×™×•×ª ×‘×›×œ ×©×™× ×•×™ ×‘××§×•×¨×•×ª ×”×—×™×¦×•× ×™×™× ××• ×¡×¤×¨×™×•×ª ×¦×“ ×©×œ×™×©×™.
          </li>
          <li>×œ×”×©×ª××© ×‘-nonces ××• hashes ×¢×‘×•×¨ inline scripts ×©×”× ×”×›×¨×—×™×™×.</li>
          <li>
            ×œ×‘×“×•×§ ××ª ×”CSP ×‘×××¦×¢×•×ª ×›×œ×™× ×›××• CSP Evaluator ××• Security Headers.
          </li>
          <li>×œ× ×˜×¨ ×”×¤×¨×•×ª CSP ×‘×××¦×¢×•×ª reporting endpoints ×•××¢×¨×›×•×ª × ×™×˜×•×¨.</li>
        </ul>
      </section>

      <section class="category">
        <h2>×¡×™×›×•×</h2>
        <p>
          Content Security Policy ×”×™× ×©×›×‘×ª ××‘×˜×—×” ×§×¨×™×˜×™×ª ×œ×× ×™×¢×ª ×”×ª×§×¤×•×ª ×¦×“ ×œ×§×•×—
          ×‘××¤×œ×™×§×¦×™×•×ª React. ×©×™×œ×•×‘ CSP ×¢× ×‘×“×™×§×•×ª ×§×œ×˜, sanitization ×•×©×™××•×© × ×›×•×Ÿ
          ×‘â€‘HTTPS ××‘×˜×™×— ××¤×œ×™×§×¦×™×” ×—×–×§×”, ×‘×˜×•×—×” ×•××•×’× ×ª ××¤× ×™ ×§×•×“ ×–×“×•× ×™.
        </p>
      </section>
    </main>
  </body>
</html>
